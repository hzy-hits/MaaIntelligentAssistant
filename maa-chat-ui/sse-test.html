<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSEè¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .event { background: #e7f5e7; padding: 8px; margin: 5px 0; border-left: 3px solid #4CAF50; }
        .error { background: #ffe7e7; padding: 8px; margin: 5px 0; border-left: 3px solid #f44336; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>MAA SSEè¿æ¥æµ‹è¯•</h1>
    
    <div>
        <button onclick="connectSSE()">è¿æ¥SSE</button>
        <button onclick="disconnectSSE()">æ–­å¼€SSE</button>
        <button onclick="sendTestEvent()">å‘é€æµ‹è¯•äº‹ä»¶</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
    <div id="log"></div>

    <script>
        let eventSource = null;
        
        function log(message, type = 'log') {
            const logDiv = document.getElementById('log');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = `çŠ¶æ€: ${status}`;
        }
        
        function connectSSE() {
            if (eventSource) {
                log('å…³é—­ç°æœ‰SSEè¿æ¥');
                eventSource.close();
            }
            
            log('ğŸ”— æ­£åœ¨è¿æ¥SSE: http://localhost:8080/sse/tasks');
            eventSource = new EventSource('http://localhost:8080/sse/tasks');
            
            eventSource.onopen = () => {
                log('âœ… SSEè¿æ¥å·²å»ºç«‹', 'event');
                updateStatus('å·²è¿æ¥');
            };
            
            eventSource.onmessage = (event) => {
                log(`ğŸ“¨ æ”¶åˆ°é»˜è®¤æ¶ˆæ¯: ${event.data}`, 'event');
            };
            
            eventSource.onerror = (error) => {
                log(`âŒ SSEè¿æ¥é”™è¯¯: ${JSON.stringify(error)}`, 'error');
                log(`âŒ ReadyState: ${eventSource.readyState}`, 'error');
                updateStatus('è¿æ¥é”™è¯¯');
            };
            
            // æ³¨å†Œè‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨
            const eventTypes = ['started', 'completed', 'failed', 'taskchain_started', 'taskchain_completed', 'heartbeat'];
            eventTypes.forEach(eventType => {
                eventSource.addEventListener(eventType, (event) => {
                    log(`ğŸ¯ æ”¶åˆ°${eventType}äº‹ä»¶: ${event.data}`, 'event');
                });
                log(`ğŸ¯ å·²æ³¨å†Œ${eventType}äº‹ä»¶ç›‘å¬å™¨`);
            });
        }
        
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                log('ğŸ”Œ SSEè¿æ¥å·²æ–­å¼€');
                updateStatus('å·²æ–­å¼€');
            }
        }
        
        function sendTestEvent() {
            log('ğŸ“¤ å‘é€æµ‹è¯•äº‹ä»¶åˆ°åç«¯');
            fetch('http://localhost:8080/sse/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: 'ğŸ§ª SSEæµ‹è¯•äº‹ä»¶ - è¿™æ˜¯æ¥è‡ªæµ‹è¯•é¡µé¢çš„æ¶ˆæ¯',
                    event_type: 'started'
                })
            })
            .then(response => response.json())
            .then(data => {
                log(`âœ… æµ‹è¯•äº‹ä»¶å‘é€æˆåŠŸ: ${JSON.stringify(data)}`);
            })
            .catch(error => {
                log(`âŒ å‘é€æµ‹è¯•äº‹ä»¶å¤±è´¥: ${error}`, 'error');
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = () => {
            log('ğŸŒŸ é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨è¿æ¥SSE');
            connectSSE();
        };
    </script>
</body>
</html>